<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="en"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets" 
    xmlns:p="http://primefaces.org/ui"
>
 <h:head>
 </h:head>
    <h:body>
	    <ui:composition>
			<div id="aside-chat">
				<h:form id='myForm'>
			   	   <h:commandButton value="Actualiser Chat">
			   		 <f:ajax execute="" render="output" />
			   	   </h:commandButton>
			   	   <br />
			   	   <p>
				   		<h:outputText id="output" value="#{ConnectedUsersBean.connectedUsersString}" escape="false" />	
			   	   </p>
			   	</h:form>
			   	<script>
			   	setInterval("clickSimulated()", 200);              
		   		
		   		function clickSimulated() {
		   			$('#btrefresh').click();
		   		};
			   	</script>
			   	<div id="chat-panel">
			   		<ui:repeat var="cur" value="#{ConnectedUsersBean.connectedUsers}">
			   			<div class='chat-window' pid='#{cur.usrId}'>
			   				<div class='chat-window-header'> 
			   					<h:outputText value='#{cur.usrFirstname} #{cur.usrLastname}'></h:outputText>
			   				</div>
			   				<div id='message-content-#{cur.usrId}' class='chat-window-content'>
		   						<h:form id='form-#{cur.usrId}' name='form-#{cur.usrId}' prependId="false">
		   							<h:outputText style="top:30px; position:absolute; height:150px;" id='messages-#{cur.usrId}' escape="false" value="#{ConnectedUsersBean.listMessagesString}">  </h:outputText>
		   							<div class='chat-window-content-controls'>
		   								<h:commandButton value='Go' actionListener='#{ConnectedUsersBean.sendMessage}'> 
		   									<f:ajax execute="@form" render="@form" />
		   								</h:commandButton>
		   								<h:inputText id='input-text-#{cur.usrId}' value='#{ConnectedUsersBean.newMessage}'></h:inputText>
		   								<h:commandButton id='btrefresh' value='refresh' actionListener='#{ConnectedUsersBean.refreshMessages}'>
		   									<f:ajax execute="@form" render="@form" />
		   								</h:commandButton>
		   							</div>
		   						</h:form>
			   				</div>
			   			</div>
			   		</ui:repeat>
			   	</div>
			   	<script>
			   		$(document).ready(function() {
			   			$('.chat-window').hide();
			   		});
			   		emptyInput = function () {
			   			$("input-text-#{cur.usrId}").val('');
			   		};
			   		

			   		// Abonnement au clic sur l'élément de chat
			   		$('.chat-element').click(function() {
			   			var id = $(this).attr('pid');
			   			var firstname = $(this).attr('pfname');
			   			var lastname = $(this).attr('plname');
			   			var chatWindow = $('.chat-window[pid="' + id + '"]');
		   			    $(chatWindow).show();
			   		});
			   		// Abonnement au clic sur l'en-tête
			   		$('.chat-window-header').click(function () {
			   			if($(this).next().height() > 0) {
			   				$(this).next().height(0);
			   				$(this).next().hide();
			   				$(this).width(200);
			   				$(this).css('position', 'absolute');
			   				$(this).css('bottom', '0px');
			   			}
			   			else {
			   				$(this).parent().show();
			   				$(this).next().height(200);
			   				$(this).css('position', 'relative');
			   				$(this).css('bottom', '');
			   				$(this).next().show();
			   			}
			   				
			   		});
			   	</script>
			</div>
		</ui:composition>
	</h:body>
</html>